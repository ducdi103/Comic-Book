<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üéÆ Mario Mini ‚Äî 10 m√†n</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="styles.css">
  <style>
    .game-wrap { padding:10px; text-align:center; }
    #gameCanvas{
      background:#0a0a0a; border:1px solid var(--border);
      border-radius:12px; box-shadow:var(--shadow);
      width:100%; max-width:360px; height:auto;
    }
    .hud{ margin:8px 0; }
    .hud .pill{
      display:inline-block; padding:6px 10px; border-radius:999px;
      background:var(--surface); border:1px solid var(--border);
      margin:2px 4px; color:var(--text);
    }
    .ctrl{ margin-top:8px; }
    .ctrl button{ min-width:92px; }
    .ctrl .wide{ min-width:188px; }
    .note{ color:var(--muted); font-size:12px; margin-top:6px; }
  </style>
</head>
<body id="">
  <div class="navbar">
    <h1>üéÆ Mario Mini (10 m√†n)</h1>
    <div class="btn-row">
      <button id="toggle-dark">üåô Dark</button>
      <a class="btn" href="index.html">üè† Trang ch·ªß</a>
    </div>
  </div>

  <div class="game-wrap">
    <div class="card">
      <canvas id="gameCanvas" width="320" height="180"></canvas>
      <div class="hud">
        <span class="pill">M√†n: <b id="lv">1/10</b></span>
        <span class="pill">ƒêi·ªÉm: <b id="score">0</b></span>
        <span class="pill">K·ª∑ l·ª•c: <b id="best">0</b></span>
        <span class="pill" id="stateTxt">S·∫µn s√†ng</span>
      </div>
      <div class="ctrl">
        <button class="btn-secondary" id="btnLeft">‚¨ÖÔ∏è Tr√°i</button>
        <button class="btn-secondary" id="btnRight">‚û°Ô∏è Ph·∫£i</button>
        <button class="btn-secondary wide" id="btnJump">‚¨ÜÔ∏è Nh·∫£y</button>
      </div>
      <div class="ctrl">
        <button id="btnPause">‚è∏Ô∏è T·∫°m d·ª´ng</button>
        <button id="btnRestart">üîÅ Ch∆°i l·∫°i</button>
        <button id="btnNext">‚è≠Ô∏è M√†n k·∫ø</button>
      </div>
      <div class="note">M·∫πo: Gi·ªØ Tr√°i/Ph·∫£i ƒë·ªÉ ch·∫°y, nh·∫•n Nh·∫£y ƒë·ªÉ v∆∞·ª£t h·ªë. Thu th·∫≠p coin üí∞, ch·∫°m c·ªù üèÅ ƒë·ªÉ qua m√†n.</div>
    </div>
  </div>

  <div class="footer">¬© 2025</div>

  <script src="script.js"></script>
  <script>
  (function () {
    // ƒê·ªìng b·ªô theme
    window.__initTheme && window.__initTheme();

    // Polyfill requestAnimationFrame cho WP8
    var raf = window.requestAnimationFrame || window.msRequestAnimationFrame ||
              function (cb) { return setTimeout(cb, 16); };
    var caf = window.cancelAnimationFrame || window.msCancelAnimationFrame ||
              function (id) { clearTimeout(id); };

    // --------- Canvas ----------
    var cvs = document.getElementById('gameCanvas');
    var ctx = cvs.getContext('2d');
    var W = cvs.width, H = cvs.height;

    // --------- HUD ----------
    var lvEl = document.getElementById('lv');
    var scoreEl = document.getElementById('score');
    var bestEl  = document.getElementById('best');
    var stateEl = document.getElementById('stateTxt');

    // --------- N√∫t ----------
    var btnLeft = document.getElementById('btnLeft');
    var btnRight= document.getElementById('btnRight');
    var btnJump = document.getElementById('btnJump');
    var btnPause= document.getElementById('btnPause');
    var btnRestart=document.getElementById('btnRestart');
    var btnNext = document.getElementById('btnNext');

    // --------- Tham s·ªë v·∫≠t l√Ω (ES5) ----------
    var TILE = 10;                 // h·ªá l∆∞·ªõi 10px
    var GRAV = 0.55;
    var MOVE_ACCEL = 0.5;
    var MOVE_MAX = 2.2;
    var FRICTION = 0.85;
    var JUMP_VEL = -7.5;

    // --------- Tr·∫°ng th√°i ----------
    var score = 0;
    var best  = readBest();
    bestEl.innerHTML = best;

    var levelIdx = readProgress(); // 0..9
    lvEl.innerHTML = (levelIdx+1) + "/10";

    var paused = false, running = true, animId = 0;

    // Camera
    var camX = 0, camY = 0;

    // Th·∫ø gi·ªõi/m√†n ch∆°i
    var world = null;   // {width,height, platforms[], coins[], flag{ x,y,w,h } , spawn{ x,y } }
    var player = null;  // {x,y,w,h,vx,vy,onGround,dir}

    // ƒêi·ªÅu khi·ªÉn
    var holdLeft = false, holdRight = false;

    function bindHold(btn, setter) {
      var start = function (e) { setter(true); e.preventDefault(); };
      var end   = function (e) { setter(false); e.preventDefault(); };
      if (btn.addEventListener) {
        btn.addEventListener('mousedown', start, false);
        btn.addEventListener('touchstart', start, false);
        btn.addEventListener('mouseup', end, false);
        btn.addEventListener('mouseleave', end, false);
        btn.addEventListener('touchend', end, false);
        btn.addEventListener('touchcancel', end, false);
      } else {
        btn.onmousedown = start; btn.onmouseup = end; btn.onmouseleave = end; btn.ontouchstart = start; btn.ontouchend = end;
      }
    }
    bindHold(btnLeft, function(v){ holdLeft = v; });
    bindHold(btnRight,function(v){ holdRight= v; });
    if (btnJump.addEventListener) btnJump.addEventListener('click', jump, false); else btnJump.onclick = jump;

    if (btnPause.addEventListener) btnPause.addEventListener('click', togglePause, false); else btnPause.onclick = togglePause;
    if (btnRestart.addEventListener) btnRestart.addEventListener('click', restart, false); else btnRestart.onclick = restart;
    if (btnNext.addEventListener) btnNext.addEventListener('click', nextLevel, false); else btnNext.onclick = nextLevel;

    // --------- L∆∞u tr·ªØ ---------
    function readBest() {
      try { var n = localStorage.getItem('mario_best'); return n? parseInt(n,10):0; } catch(e){ return 0; }
    }
    function writeBest(v) {
      try { localStorage.setItem('mario_best', String(v)); } catch(e){}
    }
    function readProgress() {
      try { var n = localStorage.getItem('mario_progress'); return n? Math.max(0, Math.min(9, parseInt(n,10))):0; } catch(e){ return 0; }
    }
    function writeProgress(idx) {
      try { localStorage.setItem('mario_progress', String(idx)); } catch(e){}
    }

    // ================== SINH 10 M√ÄN ==================
    // M·ªói m√†n d√†i 2000~2600px, n·ªÅn g·∫°ch + platform + h·ªë
    function buildLevel(idx) {
      var i, x;
      var width = 2000 + idx*60; // kh√≥ d·∫ßn
      var height = H;

      var platforms = [];
      var groundY = H - 20;      // m·∫∑t ƒë·∫•t d√†y 20px
      // N·ªÅn ƒë·∫•t tr·∫£i d√†i + v√†i h·ªë
      var step = 320 + Math.floor(idx*8);
      var holeW = 30 + idx*2;
      var lastX = 0;
      for (x = 0; x < width; x += step) {
        var hole = (idx>0 && (x % (step*2)===0)) ? holeW : 0;
        // ƒë·∫•t tr∆∞·ªõc h·ªë
        platforms.push({x:lastX, y:groundY, w: step - hole, h: 20});
        lastX += step + 0; // di chuy·ªÉn con tr·ªè
        // b·ªè qua ph·∫ßn h·ªë (tr·ªëng)
        if (hole>0) lastX += hole;
      }
      // N·ªÅn cu·ªëi n·∫øu thi·∫øu
      if (lastX < width) platforms.push({x:lastX, y:groundY, w: width-lastX, h:20});

      // Th√™m c√°c b·ªá tr√™n cao
      for (i=0;i<8+idx;i++){
        var px = 120 + i* (160 - idx*2) + (idx*7 % 50);
        var py = groundY - (40 + ((i*37 + idx*13)%80));
        var pw = 60 + ((i*23) % 30);
        platforms.push({x:px, y:py, w:pw, h:10});
      }

      // Coin
      var coins = [];
      for (i=0;i<22;i++){
        coins.push({x: 80 + i*90 + (idx*11%40), y: groundY-30 - ((i*13)%40), r:4, taken:false});
      }

      // C·ªù ƒë√≠ch
      var flagX = width - 80;
      var flag = {x:flagX, y:groundY-60, w:14, h:60};

      // V·ªã tr√≠ xu·∫•t ph√°t
      var spawn = {x: 30, y: groundY - 18};

      return { width: width, height: height, platforms: platforms, coins: coins, flag: flag, spawn: spawn };
    }

    // ================== PLAYER ==================
    function spawnPlayer() {
      var s = world.spawn;
      player = { x:s.x, y:s.y, w: 10, h: 14, vx:0, vy:0, onGround:false, dir:1 };
      camX = 0; camY = 0;
    }

    function jump() {
      if (player && player.onGround) {
        player.vy = JUMP_VEL;
        player.onGround = false;
      }
    }

    // ================== V√íNG L·∫∂P ==================
    function togglePause(){
      paused = !paused;
      stateEl.innerHTML = paused ? "T·∫°m d·ª´ng" : "ƒêang ch∆°i";
      if (!paused) loop(); else if (animId){ caf(animId); animId=0; }
    }

    function restart(){
      score = 0;
      loadLevel(levelIdx, true);
      stateEl.innerHTML = "ƒêang ch∆°i";
      loop();
    }

    function nextLevel(){
      // ch·ªâ cho next khi ƒë√£ v·ªÅ ƒë√≠ch ho·∫∑c mu·ªën luy·ªán m√†n sau
      levelIdx = (levelIdx+1) % 10;
      writeProgress(levelIdx);
      lvEl.innerHTML = (levelIdx+1) + "/10";
      score = 0;
      loadLevel(levelIdx, true);
      stateEl.innerHTML = "ƒêang ch∆°i";
      loop();
    }

    function loadLevel(idx, resetCam){
      world = buildLevel(idx);
      spawnPlayer();
      if (resetCam){ camX = 0; camY = 0; }
    }

    function clamp(v,a,b){ return v<a?a:(v>b?b:v); }

    // AABB collision resolve (tr·ª•c X r·ªìi tr·ª•c Y)
    function rectsOverlap(a,b){
      return !(a.x+a.w<=b.x || b.x+b.w<=a.x || a.y+a.h<=b.y || b.y+b.h<=a.y);
    }

    function moveAndCollide() {
      var i, p, a, b;

      // X input
      if (holdLeft)  { player.vx -= MOVE_ACCEL; player.dir = -1; }
      if (holdRight) { player.vx += MOVE_ACCEL; player.dir =  1; }
      player.vx = clamp(player.vx, -MOVE_MAX, MOVE_MAX);
      if (!holdLeft && !holdRight) player.vx *= FRICTION;

      // Gravity
      player.vy += GRAV; if (player.vy > 9) player.vy = 9;

      // --- Move X ---
      player.x += player.vx;
      a = {x:player.x, y:player.y, w:player.w, h:player.h};
      for (i=0;i<world.platforms.length;i++){
        p = world.platforms[i];
        if (rectsOverlap(a,p)){
          if (player.vx>0){ player.x = p.x - player.w; }
          else if (player.vx<0){ player.x = p.x + p.w; }
          player.vx = 0;
          a.x = player.x;
        }
      }

      // --- Move Y ---
      var wasOnGround = player.onGround;
      player.onGround = false;
      player.y += player.vy;
      a.y = player.y;
      for (i=0;i<world.platforms.length;i++){
        p = world.platforms[i];
        if (rectsOverlap(a,p)){
          if (player.vy>0){ // r∆°i xu·ªëng s√†n
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          } else if (player.vy<0){ // ƒë·∫≠p ƒë·∫ßu
            player.y = p.y + p.h;
            player.vy = 0.2;
          }
          a.y = player.y;
        }
      }

      // R∆°i xu·ªëng h·ªë (d∆∞·ªõi m√†n h√¨nh) -> thua
      if (player.y > H + 60){
        running = false;
        stateEl.innerHTML = "üí• R∆°i h·ªë!";
        if (score>best){ best=score; bestEl.innerHTML=best; writeBest(best); }
      }
    }

    function update(){
      if (!running || paused) return;

      moveAndCollide();

      // ƒÇn coin
      var i, c, hit;
      for (i=0;i<world.coins.length;i++){
        c = world.coins[i];
        if (!c.taken){
          hit = !(player.x+player.w < c.x- c.r || player.x > c.x + c.r || player.y+player.h < c.y- c.r || player.y > c.y + c.r);
          if (hit){ c.taken = true; score += 10; scoreEl.innerHTML = String(score); }
        }
      }

      // V·ªÅ ƒë√≠ch
      if (rectsOverlap(player, world.flag)){
        running = false;
        stateEl.innerHTML = "üèÅ Ho√†n th√†nh!";
        score += 100 + levelIdx*10;
        scoreEl.innerHTML = String(score);
        if (score>best){ best=score; bestEl.innerHTML=best; writeBest(best); }

        // m·ªü m√†n ti·∫øp theo
        if (levelIdx < 9){ levelIdx++; writeProgress(levelIdx); lvEl.innerHTML = (levelIdx+1)+"/10"; }
      }

      // Camera b√°m ng∆∞·ªùi ch∆°i (gi·ªõi h·∫°n trong world)
      camX = clamp(player.x - W/2 + player.w/2, 0, world.width - W);
    }

    // V·∫Ω kh·ªëi ch·ªØ nh·∫≠t
    function fillRect(x,y,w,h,color){ ctx.fillStyle=color; ctx.fillRect(Math.floor(x),Math.floor(y),Math.floor(w),Math.floor(h)); }

    function draw(){
      var dark = (document.body.id==='dark-mode');
      // n·ªÅn b·∫ßu tr·ªùi
      ctx.fillStyle = dark ? '#0b0b0f' : '#87ceeb';
      ctx.fillRect(0,0,W,H);

      // m·∫∑t ƒë·∫•t & platform
      var i,p,cx;
      for(i=0;i<world.platforms.length;i++){
        p = world.platforms[i];
        cx = p.x - camX;
        if (cx+p.w < -20 || cx > W+20) continue;
        fillRect(cx, p.y, p.w, p.h, dark? '#334155' : '#5aa35a');
        // vi·ªÅn nh·∫π
        fillRect(cx, p.y, p.w, 2, dark? '#475569' : '#7ac77a');
      }

      // C·ªù ƒë√≠ch
      var f = world.flag, fx = f.x - camX;
      fillRect(fx+6, f.y, 2, f.h, dark? '#94a3b8' : '#5b6068');         // c·ªôt
      fillRect(fx-8, f.y, 14, 10, dark? '#60a5fa' : '#2563eb');          // l√° c·ªù
      fillRect(fx, f.y+f.h, 16, 4, dark? '#475569' : '#9ca3af');        // ch√¢n c·ªôt

      // Coin
      for(i=0;i<world.coins.length;i++){
        var cc = world.coins[i];
        if (cc.taken) continue;
        var cx2 = cc.x - camX;
        if (cx2 < -20 || cx2 > W+20) continue;
        ctx.beginPath();
        ctx.arc(Math.floor(cx2), Math.floor(cc.y), cc.r, 0, Math.PI*2, false);
        ctx.fillStyle = dark ? '#fbbf24' : '#f59e0b';
        ctx.fill();
      }

      // Player (√°o ƒë·ªè, qu·∫ßn xanh)
      var px = player.x - camX;
      fillRect(px, player.y, player.w, player.h, dark? '#ef4444' : '#dc2626'); // th√¢n
      fillRect(px, player.y+8, player.w, 6, dark? '#60a5fa' : '#2563eb');      // qu·∫ßn
      // m≈© nh·ªè
      fillRect(px, player.y-2, player.w, 2, dark? '#ef4444' : '#dc2626');

      // Khi thua, overlay
      if (!running && stateEl.innerHTML.indexOf("Ho√†n th√†nh")===-1){
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.fillRect(0,0,W,H);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 16px Segoe UI, Tahoma';
        ctx.fillText('Thua r·ªìi! ƒêi·ªÉm: ' + score, 86, 82);
        ctx.fillText('Nh·∫•n "Ch∆°i l·∫°i"', 102, 102);
      }
    }

    function loop(){
      if (!running || paused){ draw(); return; }
      update();
      draw();
      animId = raf(loop);
    }

    // ---------- Kh·ªüi t·∫°o ----------
    function start(){
      running = true; paused = false; stateEl.innerHTML = "ƒêang ch∆°i";
      score = 0; scoreEl.innerHTML = "0";
      loadLevel(levelIdx, true);
      loop();
    }
    start();

  })();
  </script>
</body>
</html>
